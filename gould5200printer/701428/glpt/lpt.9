(COMMENT SPOOLER FOR LPT STYLE PRINTING OF ASCII FILES)

(DECLARE (SPECIAL IN-FILE WRAP-AROUND LPT-COMMANDS)
	 (*EXPR DIRECTORY BEGIN-PAGE DPWORD)
	 (fixnum (dpword fixnum) byte word)
	 (array* (fixnum (linearray 270.))))

(DECLARE (EVAL (READ)))
(FASLOAD LSPMAC FASL DSK JLK)

(DECLARE (EVAL (READ)))
(SETSYNTAX '/& 'MACRO '(LAMBDA () (+ 1_17 (READ)))) ; PRINTER COMMANDS

;;;	Special printer codes

(DECLARE (EVAL (READ)))
(SETQ ACK 301 TDQOT 215 TDORS 214 TDCLR 216 TDNOP 210 BEGIN 205 EOF 206 HOME &200
      LINE+ &201 INIT &4 ENABLE &3 FINISH &70177 FORM-FEED &0 CUT-PAPER &2 GMODE &1
      LAST-LINE &5 ENABLE-INTS &6 DISABLE-INTS &7 NEW-PAGE &40000 GRAPHICS-MODE 10000
      REPEAT &301 TERMIN &302 MAX-SLEEP-PERIODS 120. SPOOL-SLEEP-TIME 5. MAIL-TIME 5.)

(DECLARE (EVAL (READ)))
(SETQ BOTTOM-MARGIN 2 TOP-MARGIN 5 DOLLAR 44 SPACE 40 CARET 136
      PAGE-SIZE 62. MAX-LINE-SIZE 132.)

;; Implement skip for this mode.  page size??, MARGINS (TOP, SIDE)

(DEFUN LPT-PRINT (FILE)
       (SETQ IN-FILE (OPEN FILE '(IN DSK IMAGE)))
       (TOP-PAGE)
       (DO ((CH (TYI IN-FILE) (TYI IN-FILE)) (LCNT 0)
	    (I 0 (1+ I)) (ID 1) (OVER-RUN)
	    (CC (CADDAR (DIRECTORY (LIST (TRUENAME IN-FILE)) '(CHARACTERS))))
	    (WORDC (CADDAR (DIRECTORY (LIST (TRUENAME IN-FILE)) '(WORDS)))))
	   ((OR (= CH -1) (= I CC)) (FINISH-LINE ID) (HOME-DOWN LCNT) (CLOSE IN-FILE))
	   (DECLARE (FIXNUM ID CH CC WORDC LCNT))
	   (COND ((NOT (AND (OR (= 3 CH) (= 14 CH))
			    (NOT (> WORDC (1+ (// (FILEPOS IN-FILE) 5))))))
		  (COND ((= 33 CH) (SETQ CH #DOLLAR)))
		  (COND ((OR (= 14 CH) (= 12 CH))
			 (FINISH-LINE ID)
			 (SETQ ID 1 LCNT (1+ LCNT)) OVER-RUN NIL))
		  (COND ((OR (= 14 CH) (= #PAGE-SIZE LCNT))
			 (ASCII-FF LCNT) (SETQ LCNT 0))
			((OR (= 15 CH) (= 12 CH) OVER-RUN))
			((= 11 CH)
			 (DO I (- (MIN #MAX-LINE-SIZE
				       (1+ (* 10 (1+ (// (1- ID) 10)))))
				  ID)
			     (1- I) (= 0 I) (STORE (LINEARRAY ID) #SPACE)
			     (SETQ ID (1+ ID))))
			((< CH 40)
			 (STORE (LINEARRAY ID) #CARET)
			 (STORE (LINEARRAY (SETQ ID (1+ ID))) (+ 100 CH))
			 (SETQ ID (1+ ID)))
			(T (STORE (LINEARRAY ID) CH) (SETQ ID (1+ ID))))))
	   (COND ((OR (AND WRAP-AROUND (> ID #(1- MAX-LINE-SIZE)))
		      (= ID #MAX-LINE-SIZE))
		  (COND ((NOT WRAP-AROUND)
			 (STORE (LINEARRAY ID) 174)
			 (SETQ ID (1+ ID))))
		  (FINISH-LINE ID) (SETQ ID 1 LCNT (1+ LCNT))
		  (SETQ OVER-RUN WRAP-AROUND)))))

(DEFUN FINISH-LINE (ID)
       (COND ((= 1 ID) (LINE-FEED))
	     (T (DPWORD (// ID 2))
		(DO ((I 1 (1+ (1+ I))))
		    ((NOT (< I ID)))
		    (DPWORD (+ (LSH (LINEARRAY I) 10)
			       (OR (AND (NOT (< (1+ I) ID)) #SPACE)
				   (LINEARRAY (1+ I)))))))))

(DEFUN ASCII-FF (LC) (HOME-DOWN LC) (TOP-PAGE))

(DEFUN HOME-DOWN (LC)
   (LAMBIND ((X (- #(+ BOTTOM-MARGIN PAGE-SIZE) LC)))
	     (COND ((> X 0) (DPWORD #REPEAT) (DPWORD X) (LINE-FEED) (DPWORD #TERMIN)))))

(DEFUN TOP-PAGE ()
    (BEGIN-PAGE)
    (COND ((> #TOP-MARGIN 0)
	   (DPWORD #REPEAT)
	   (DPWORD #TOP-MARGIN)
	   (LINE-FEED)
	   (DPWORD #TERMIN))))

(DEFUN LINE-FEED NIL 
       (DPWORD 1) (DPWORD #(+ SPACE (LSH SPACE 10)))) ;(DPWORD #LINE+)

